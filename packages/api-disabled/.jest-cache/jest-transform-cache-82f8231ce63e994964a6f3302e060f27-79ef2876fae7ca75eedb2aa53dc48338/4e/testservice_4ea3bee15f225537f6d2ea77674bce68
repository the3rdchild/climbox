c581539842e9beeda285058e1d68d52a
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TestService = void 0;
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("typeorm");
const bluebird_1 = __importDefault(require("bluebird"));
const app_module_1 = require("../src/app.module");
const users_entity_1 = require("../src/users/users.entity");
const sites_entity_1 = require("../src/sites/sites.entity");
const site_survey_points_entity_1 = require("../src/site-survey-points/site-survey-points.entity");
const global_validation_pipe_1 = require("../src/validations/global-validation.pipe");
const site_applications_entity_1 = require("../src/site-applications/site-applications.entity");
const sources_entity_1 = require("../src/sites/sources.entity");
const time_series_entity_1 = require("../src/time-series/time-series.entity");
const collections_entity_1 = require("../src/collections/collections.entity");
const daily_data_entity_1 = require("../src/sites/daily-data.entity");
const regions_entity_1 = require("../src/regions/regions.entity");
const surveys_entity_1 = require("../src/surveys/surveys.entity");
const historical_monthly_mean_entity_1 = require("../src/sites/historical-monthly-mean.entity");
const survey_media_entity_1 = require("../src/surveys/survey-media.entity");
const exclusion_dates_entity_1 = require("../src/sites/exclusion-dates.entity");
const temperature_1 = require("../src/utils/temperature");
const user_mock_1 = require("./mock/user.mock");
const site_mock_1 = require("./mock/site.mock");
const survey_point_mock_1 = require("./mock/survey-point.mock");
const site_application_mock_1 = require("./mock/site-application.mock");
const source_mock_1 = require("./mock/source.mock");
const time_series_mock_1 = require("./mock/time-series.mock");
const collection_mock_1 = require("./mock/collection.mock");
const daily_data_mock_1 = require("./mock/daily-data.mock");
const surveys_mock_1 = require("./mock/surveys.mock");
const survey_media_mock_1 = require("./mock/survey-media.mock");
class TestService {
    constructor() {
        this.app = null;
    }
    initializeApp() {
        return __awaiter(this, void 0, void 0, function* () {
            const moduleFixture = yield testing_1.Test.createTestingModule({
                imports: [app_module_1.AppModule],
            }).compile();
            this.app = moduleFixture.createNestApplication();
            yield this.app.init();
            this.app.useGlobalPipes(new global_validation_pipe_1.GlobalValidationPipe({
                transform: true,
                skipTransformIds: ['appId'],
            }));
            const connection = this.app.get(typeorm_1.DataSource);
            try {
                // Clean up database
                yield this.cleanAllEntities(connection);
            }
            catch (err) {
                // eslint-disable-next-line no-console
                console.log('Clean up failed');
                throw err;
            }
            try {
                // Make sure database is up-to-date
                yield connection.runMigrations({ transaction: 'each' });
            }
            catch (err) {
                // eslint-disable-next-line no-console
                console.log('Migrations failed to run');
                throw err;
            }
            try {
                // Load mock entities
                yield this.loadMocks(connection);
            }
            catch (err) {
                // eslint-disable-next-line no-console
                console.log('Mocks failed to load');
                throw err;
            }
        });
    }
    loadMocks(connection) {
        return __awaiter(this, void 0, void 0, function* () {
            yield connection.getRepository(users_entity_1.User).save(user_mock_1.users);
            yield connection.getRepository(sites_entity_1.Site).save(site_mock_1.sites);
            yield connection.getRepository(site_survey_points_entity_1.SiteSurveyPoint).save(survey_point_mock_1.surveyPoints);
            yield connection.getRepository(site_applications_entity_1.SiteApplication).save(site_application_mock_1.siteApplications);
            yield connection.getRepository(sources_entity_1.Sources).save(source_mock_1.sources);
            yield connection.getRepository(time_series_entity_1.TimeSeries).save(time_series_mock_1.timeSeries);
            yield connection.query('REFRESH MATERIALIZED VIEW latest_data');
            yield connection.getRepository(collections_entity_1.Collection).save(collection_mock_1.collections);
            yield connection.getRepository(daily_data_entity_1.DailyData).save(daily_data_mock_1.dailyData);
            yield connection.getRepository(surveys_entity_1.Survey).save(surveys_mock_1.surveys);
            yield connection.getRepository(survey_media_entity_1.SurveyMedia).save(survey_media_mock_1.surveyMedia);
            yield bluebird_1.default.map(site_mock_1.sites, (site) => __awaiter(this, void 0, void 0, function* () {
                const [longitude, latitude] = site.polygon.coordinates;
                const historicalMonthlyMean = yield (0, temperature_1.getHistoricalMonthlyMeans)(longitude, latitude);
                return bluebird_1.default.map(historicalMonthlyMean, (hmm) => {
                    return connection.getRepository(historical_monthly_mean_entity_1.HistoricalMonthlyMean).save({
                        site,
                        month: hmm.month,
                        temperature: hmm.temperature,
                    });
                });
            }));
        });
    }
    static getInstance() {
        this.instance = this.instance || new TestService();
        return this.instance;
    }
    getApp() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.app) {
                yield this.initializeApp();
            }
            return this.app;
        });
    }
    getDataSource() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.app) {
                yield this.initializeApp();
            }
            return this.app.get(typeorm_1.DataSource);
        });
    }
    cleanUpApp() {
        if (!this.app) {
            return Promise.resolve();
        }
        return this.app.close();
    }
    cleanAllEntities(connection) {
        return __awaiter(this, void 0, void 0, function* () {
            yield connection.getRepository(time_series_entity_1.TimeSeries).delete({});
            yield connection.getRepository(sources_entity_1.Sources).delete({});
            yield connection.getRepository(collections_entity_1.Collection).delete({});
            yield connection.getRepository(regions_entity_1.Region).delete({});
            yield connection.getRepository(site_applications_entity_1.SiteApplication).delete({});
            yield connection.getRepository(site_survey_points_entity_1.SiteSurveyPoint).delete({});
            yield connection.getRepository(daily_data_entity_1.DailyData).delete({});
            yield connection.getRepository(exclusion_dates_entity_1.ExclusionDates).delete({});
            yield connection.getRepository(surveys_entity_1.Survey).delete({});
            yield connection.getRepository(survey_media_entity_1.SurveyMedia).delete({});
            yield connection.getRepository(historical_monthly_mean_entity_1.HistoricalMonthlyMean).delete({});
            yield connection.getRepository(sites_entity_1.Site).delete({});
            yield connection.getRepository(users_entity_1.User).delete({});
        });
    }
}
exports.TestService = TestService;
TestService.instance = null;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvdXNlci9jbGltYm94L3BhY2thZ2VzL2FwaS90ZXN0L3Rlc3Quc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFDQSw2Q0FBc0Q7QUFDdEQscUNBQXFDO0FBRXJDLHdEQUFnQztBQUNoQyxrREFBOEM7QUFDOUMsNERBQWlEO0FBQ2pELDREQUFpRDtBQUNqRCxtR0FBc0Y7QUFDdEYsc0ZBQWlGO0FBQ2pGLGdHQUFvRjtBQUNwRixnRUFBc0Q7QUFDdEQsOEVBQW1FO0FBQ25FLDhFQUFtRTtBQUNuRSxzRUFBMkQ7QUFDM0Qsa0VBQXVEO0FBQ3ZELGtFQUF1RDtBQUN2RCxnR0FBb0Y7QUFDcEYsNEVBQWlFO0FBQ2pFLGdGQUFxRTtBQUNyRSwwREFBcUU7QUFDckUsZ0RBQXlDO0FBQ3pDLGdEQUF5QztBQUN6QyxnRUFBd0Q7QUFDeEQsd0VBQWdFO0FBQ2hFLG9EQUE2QztBQUM3Qyw4REFBcUQ7QUFDckQsNERBQXFEO0FBQ3JELDREQUFtRDtBQUNuRCxzREFBOEM7QUFDOUMsZ0VBQXVEO0FBRXZELE1BQWEsV0FBVztJQUl0QjtRQUZRLFFBQUcsR0FBNEIsSUFBSSxDQUFDO0lBRXJCLENBQUM7SUFFVixhQUFhOztZQUN6QixNQUFNLGFBQWEsR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7Z0JBQ2xFLE9BQU8sRUFBRSxDQUFDLHNCQUFTLENBQUM7YUFDckIsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBRWIsSUFBSSxDQUFDLEdBQUcsR0FBRyxhQUFhLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUVqRCxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFdEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQ3JCLElBQUksNkNBQW9CLENBQUM7Z0JBQ3ZCLFNBQVMsRUFBRSxJQUFJO2dCQUNmLGdCQUFnQixFQUFFLENBQUMsT0FBTyxDQUFDO2FBQzVCLENBQUMsQ0FDSCxDQUFDO1lBRUYsTUFBTSxVQUFVLEdBQUcsSUFB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RSxDQUFDLENBQUM7WUFDdEQsTUFBTSxVQUFVLENBQUMsYUFBYSxDQUFDLHVCQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbEQsTUFBTSxVQUFVLENBQUMsYUFBYSxDQUFDLDBDQUFlLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDM0QsTUFBTSxVQUFVLENBQUMsYUFBYSxDQUFDLDJDQUFlLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDM0QsTUFBTSxVQUFVLENBQUMsYUFBYSxDQUFDLDZCQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDckQsTUFBTSxVQUFVLENBQUMsYUFBYSxDQUFDLHVDQUFjLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDMUQsTUFBTSxVQUFVLENBQUMsYUFBYSxDQUFDLHVCQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbEQsTUFBTSxVQUFVLENBQUMsYUFBYSxDQUFDLGlDQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkQsTUFBTSxVQUFVLENBQUMsYUFBYSxDQUFDLHNEQUFxQixDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2pFLE1BQU0sVUFBVSxDQUFDLGFBQWEsQ0FBQyxtQkFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELE1BQU0sVUFBVSxDQUFDLGFBQWEsQ0FBQyxtQkFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELENBQUM7S0FBQTs7QUE1SEgsa0NBNkhDO0FBNUhnQixvQkFBUSxHQUF1QixJQUFJLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvdXNlci9jbGltYm94L3BhY2thZ2VzL2FwaS90ZXN0L3Rlc3Quc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJTmVzdEFwcGxpY2F0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xyXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcclxuaW1wb3J0IHsgRGF0YVNvdXJjZSB9IGZyb20gJ3R5cGVvcm0nO1xyXG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJ2dlb2pzb24nO1xyXG5pbXBvcnQgQmx1ZWJpcmQgZnJvbSAnYmx1ZWJpcmQnO1xyXG5pbXBvcnQgeyBBcHBNb2R1bGUgfSBmcm9tICcuLi9zcmMvYXBwLm1vZHVsZSc7XHJcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi9zcmMvdXNlcnMvdXNlcnMuZW50aXR5JztcclxuaW1wb3J0IHsgU2l0ZSB9IGZyb20gJy4uL3NyYy9zaXRlcy9zaXRlcy5lbnRpdHknO1xyXG5pbXBvcnQgeyBTaXRlU3VydmV5UG9pbnQgfSBmcm9tICcuLi9zcmMvc2l0ZS1zdXJ2ZXktcG9pbnRzL3NpdGUtc3VydmV5LXBvaW50cy5lbnRpdHknO1xyXG5pbXBvcnQgeyBHbG9iYWxWYWxpZGF0aW9uUGlwZSB9IGZyb20gJy4uL3NyYy92YWxpZGF0aW9ucy9nbG9iYWwtdmFsaWRhdGlvbi5waXBlJztcclxuaW1wb3J0IHsgU2l0ZUFwcGxpY2F0aW9uIH0gZnJvbSAnLi4vc3JjL3NpdGUtYXBwbGljYXRpb25zL3NpdGUtYXBwbGljYXRpb25zLmVudGl0eSc7XHJcbmltcG9ydCB7IFNvdXJjZXMgfSBmcm9tICcuLi9zcmMvc2l0ZXMvc291cmNlcy5lbnRpdHknO1xyXG5pbXBvcnQgeyBUaW1lU2VyaWVzIH0gZnJvbSAnLi4vc3JjL3RpbWUtc2VyaWVzL3RpbWUtc2VyaWVzLmVudGl0eSc7XHJcbmltcG9ydCB7IENvbGxlY3Rpb24gfSBmcm9tICcuLi9zcmMvY29sbGVjdGlvbnMvY29sbGVjdGlvbnMuZW50aXR5JztcclxuaW1wb3J0IHsgRGFpbHlEYXRhIH0gZnJvbSAnLi4vc3JjL3NpdGVzL2RhaWx5LWRhdGEuZW50aXR5JztcclxuaW1wb3J0IHsgUmVnaW9uIH0gZnJvbSAnLi4vc3JjL3JlZ2lvbnMvcmVnaW9ucy5lbnRpdHknO1xyXG5pbXBvcnQgeyBTdXJ2ZXkgfSBmcm9tICcuLi9zcmMvc3VydmV5cy9zdXJ2ZXlzLmVudGl0eSc7XHJcbmltcG9ydCB7IEhpc3RvcmljYWxNb250aGx5TWVhbiB9IGZyb20gJy4uL3NyYy9zaXRlcy9oaXN0b3JpY2FsLW1vbnRobHktbWVhbi5lbnRpdHknO1xyXG5pbXBvcnQgeyBTdXJ2ZXlNZWRpYSB9IGZyb20gJy4uL3NyYy9zdXJ2ZXlzL3N1cnZleS1tZWRpYS5lbnRpdHknO1xyXG5pbXBvcnQgeyBFeGNsdXNpb25EYXRlcyB9IGZyb20gJy4uL3NyYy9zaXRlcy9leGNsdXNpb24tZGF0ZXMuZW50aXR5JztcclxuaW1wb3J0IHsgZ2V0SGlzdG9yaWNhbE1vbnRobHlNZWFucyB9IGZyb20gJy4uL3NyYy91dGlscy90ZW1wZXJhdHVyZSc7XHJcbmltcG9ydCB7IHVzZXJzIH0gZnJvbSAnLi9tb2NrL3VzZXIubW9jayc7XHJcbmltcG9ydCB7IHNpdGVzIH0gZnJvbSAnLi9tb2NrL3NpdGUubW9jayc7XHJcbmltcG9ydCB7IHN1cnZleVBvaW50cyB9IGZyb20gJy4vbW9jay9zdXJ2ZXktcG9pbnQubW9jayc7XHJcbmltcG9ydCB7IHNpdGVBcHBsaWNhdGlvbnMgfSBmcm9tICcuL21vY2svc2l0ZS1hcHBsaWNhdGlvbi5tb2NrJztcclxuaW1wb3J0IHsgc291cmNlcyB9IGZyb20gJy4vbW9jay9zb3VyY2UubW9jayc7XHJcbmltcG9ydCB7IHRpbWVTZXJpZXMgfSBmcm9tICcuL21vY2svdGltZS1zZXJpZXMubW9jayc7XHJcbmltcG9ydCB7IGNvbGxlY3Rpb25zIH0gZnJvbSAnLi9tb2NrL2NvbGxlY3Rpb24ubW9jayc7XHJcbmltcG9ydCB7IGRhaWx5RGF0YSB9IGZyb20gJy4vbW9jay9kYWlseS1kYXRhLm1vY2snO1xyXG5pbXBvcnQgeyBzdXJ2ZXlzIH0gZnJvbSAnLi9tb2NrL3N1cnZleXMubW9jayc7XHJcbmltcG9ydCB7IHN1cnZleU1lZGlhIH0gZnJvbSAnLi9tb2NrL3N1cnZleS1tZWRpYS5tb2NrJztcclxuXHJcbmV4cG9ydCBjbGFzcyBUZXN0U2VydmljZSB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IFRlc3RTZXJ2aWNlIHwgbnVsbCA9IG51bGw7XHJcbiAgcHJpdmF0ZSBhcHA6IElOZXN0QXBwbGljYXRpb24gfCBudWxsID0gbnVsbDtcclxuXHJcbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHt9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgaW5pdGlhbGl6ZUFwcCgpIHtcclxuICAgIGNvbnN0IG1vZHVsZUZpeHR1cmU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xyXG4gICAgICBpbXBvcnRzOiBbQXBwTW9kdWxlXSxcclxuICAgIH0pLmNvbXBpbGUoKTtcclxuXHJcbiAgICB0aGlzLmFwcCA9IG1vZHVsZUZpeHR1cmUuY3JlYXRlTmVzdEFwcGxpY2F0aW9uKCk7XHJcblxyXG4gICAgYXdhaXQgdGhpcy5hcHAuaW5pdCgpO1xyXG5cclxuICAgIHRoaXMuYXBwLnVzZUdsb2JhbFBpcGVzKFxyXG4gICAgICBuZXcgR2xvYmFsVmFsaWRhdGlvblBpcGUoe1xyXG4gICAgICAgIHRyYW5zZm9ybTogdHJ1ZSxcclxuICAgICAgICBza2lwVHJhbnNmb3JtSWRzOiBbJ2FwcElkJ10sXHJcbiAgICAgIH0pLFxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBjb25uZWN0aW9uID0gdGhpcy5hcHAuZ2V0KERhdGFTb3VyY2UpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gQ2xlYW4gdXAgZGF0YWJhc2VcclxuICAgICAgYXdhaXQgdGhpcy5jbGVhbkFsbEVudGl0aWVzKGNvbm5lY3Rpb24pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXHJcbiAgICAgIGNvbnNvbGUubG9nKCdDbGVhbiB1cCBmYWlsZWQnKTtcclxuICAgICAgdGhyb3cgZXJyO1xyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIE1ha2Ugc3VyZSBkYXRhYmFzZSBpcyB1cC10by1kYXRlXHJcbiAgICAgIGF3YWl0IGNvbm5lY3Rpb24ucnVuTWlncmF0aW9ucyh7IHRyYW5zYWN0aW9uOiAnZWFjaCcgfSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcclxuICAgICAgY29uc29sZS5sb2coJ01pZ3JhdGlvbnMgZmFpbGVkIHRvIHJ1bicpO1xyXG4gICAgICB0aHJvdyBlcnI7XHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gTG9hZCBtb2NrIGVudGl0aWVzXHJcbiAgICAgIGF3YWl0IHRoaXMubG9hZE1vY2tzKGNvbm5lY3Rpb24pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXHJcbiAgICAgIGNvbnNvbGUubG9nKCdNb2NrcyBmYWlsZWQgdG8gbG9hZCcpO1xyXG4gICAgICB0aHJvdyBlcnI7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIGxvYWRNb2Nrcyhjb25uZWN0aW9uOiBEYXRhU291cmNlKSB7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoVXNlcikuc2F2ZSh1c2Vycyk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoU2l0ZSkuc2F2ZShzaXRlcyk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoU2l0ZVN1cnZleVBvaW50KS5zYXZlKHN1cnZleVBvaW50cyk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoU2l0ZUFwcGxpY2F0aW9uKS5zYXZlKHNpdGVBcHBsaWNhdGlvbnMpO1xyXG4gICAgYXdhaXQgY29ubmVjdGlvbi5nZXRSZXBvc2l0b3J5KFNvdXJjZXMpLnNhdmUoc291cmNlcyk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoVGltZVNlcmllcykuc2F2ZSh0aW1lU2VyaWVzKTtcclxuICAgIGF3YWl0IGNvbm5lY3Rpb24ucXVlcnkoJ1JFRlJFU0ggTUFURVJJQUxJWkVEIFZJRVcgbGF0ZXN0X2RhdGEnKTtcclxuICAgIGF3YWl0IGNvbm5lY3Rpb24uZ2V0UmVwb3NpdG9yeShDb2xsZWN0aW9uKS5zYXZlKGNvbGxlY3Rpb25zKTtcclxuICAgIGF3YWl0IGNvbm5lY3Rpb24uZ2V0UmVwb3NpdG9yeShEYWlseURhdGEpLnNhdmUoZGFpbHlEYXRhKTtcclxuICAgIGF3YWl0IGNvbm5lY3Rpb24uZ2V0UmVwb3NpdG9yeShTdXJ2ZXkpLnNhdmUoc3VydmV5cyk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoU3VydmV5TWVkaWEpLnNhdmUoc3VydmV5TWVkaWEpO1xyXG5cclxuICAgIGF3YWl0IEJsdWViaXJkLm1hcChzaXRlcywgYXN5bmMgKHNpdGUpID0+IHtcclxuICAgICAgY29uc3QgW2xvbmdpdHVkZSwgbGF0aXR1ZGVdID0gKHNpdGUucG9seWdvbiBhcyBQb2ludCkuY29vcmRpbmF0ZXM7XHJcbiAgICAgIGNvbnN0IGhpc3RvcmljYWxNb250aGx5TWVhbiA9IGF3YWl0IGdldEhpc3RvcmljYWxNb250aGx5TWVhbnMoXHJcbiAgICAgICAgbG9uZ2l0dWRlLFxyXG4gICAgICAgIGxhdGl0dWRlLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgcmV0dXJuIEJsdWViaXJkLm1hcChoaXN0b3JpY2FsTW9udGhseU1lYW4sIChobW0pID0+IHtcclxuICAgICAgICByZXR1cm4gY29ubmVjdGlvbi5nZXRSZXBvc2l0b3J5KEhpc3RvcmljYWxNb250aGx5TWVhbikuc2F2ZSh7XHJcbiAgICAgICAgICBzaXRlLFxyXG4gICAgICAgICAgbW9udGg6IGhtbS5tb250aCxcclxuICAgICAgICAgIHRlbXBlcmF0dXJlOiBobW0udGVtcGVyYXR1cmUsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3RhdGljIGdldEluc3RhbmNlKCkge1xyXG4gICAgdGhpcy5pbnN0YW5jZSA9IHRoaXMuaW5zdGFuY2UgfHwgbmV3IFRlc3RTZXJ2aWNlKCk7XHJcbiAgICByZXR1cm4gdGhpcy5pbnN0YW5jZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBnZXRBcHAoKSB7XHJcbiAgICBpZiAoIXRoaXMuYXBwKSB7XHJcbiAgICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZUFwcCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmFwcCE7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZ2V0RGF0YVNvdXJjZSgpIHtcclxuICAgIGlmICghdGhpcy5hcHApIHtcclxuICAgICAgYXdhaXQgdGhpcy5pbml0aWFsaXplQXBwKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuYXBwIS5nZXQoRGF0YVNvdXJjZSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgY2xlYW5VcEFwcCgpIHtcclxuICAgIGlmICghdGhpcy5hcHApIHtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmFwcC5jbG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGNsZWFuQWxsRW50aXRpZXMoY29ubmVjdGlvbjogRGF0YVNvdXJjZSkge1xyXG4gICAgYXdhaXQgY29ubmVjdGlvbi5nZXRSZXBvc2l0b3J5KFRpbWVTZXJpZXMpLmRlbGV0ZSh7fSk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoU291cmNlcykuZGVsZXRlKHt9KTtcclxuICAgIGF3YWl0IGNvbm5lY3Rpb24uZ2V0UmVwb3NpdG9yeShDb2xsZWN0aW9uKS5kZWxldGUoe30pO1xyXG4gICAgYXdhaXQgY29ubmVjdGlvbi5nZXRSZXBvc2l0b3J5KFJlZ2lvbikuZGVsZXRlKHt9KTtcclxuICAgIGF3YWl0IGNvbm5lY3Rpb24uZ2V0UmVwb3NpdG9yeShTaXRlQXBwbGljYXRpb24pLmRlbGV0ZSh7fSk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoU2l0ZVN1cnZleVBvaW50KS5kZWxldGUoe30pO1xyXG4gICAgYXdhaXQgY29ubmVjdGlvbi5nZXRSZXBvc2l0b3J5KERhaWx5RGF0YSkuZGVsZXRlKHt9KTtcclxuICAgIGF3YWl0IGNvbm5lY3Rpb24uZ2V0UmVwb3NpdG9yeShFeGNsdXNpb25EYXRlcykuZGVsZXRlKHt9KTtcclxuICAgIGF3YWl0IGNvbm5lY3Rpb24uZ2V0UmVwb3NpdG9yeShTdXJ2ZXkpLmRlbGV0ZSh7fSk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoU3VydmV5TWVkaWEpLmRlbGV0ZSh7fSk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoSGlzdG9yaWNhbE1vbnRobHlNZWFuKS5kZWxldGUoe30pO1xyXG4gICAgYXdhaXQgY29ubmVjdGlvbi5nZXRSZXBvc2l0b3J5KFNpdGUpLmRlbGV0ZSh7fSk7XHJcbiAgICBhd2FpdCBjb25uZWN0aW9uLmdldFJlcG9zaXRvcnkoVXNlcikuZGVsZXRlKHt9KTtcclxuICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9